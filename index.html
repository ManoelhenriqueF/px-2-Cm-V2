<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pixel 2 Cm</title>
  <link rel="icon" type="image/x-icon" href="icone v2 sem nome.png">
  <style>
    @font-face {
      font-family: 'Championship';
      src: url('Championship.ttf') format('truetype');
    }

    body {
      font-family: 'Impact', sans-serif;
      margin: 0;
      background-color: #1e1e1e;
      color: #fff;
    }

    header {
      background-color: #000;
      display: flex;
      align-items: center;
      padding: 10px 20px;
    }

    header img {
      height: 80px;
      margin-right: 15px;
    }

    header h1 {
      font-family: 'Championship', Impact, sans-serif;
      color: #ff3c00;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    main {
      display: flex;
      padding: 40px;
      gap: 40px;
      align-items: flex-start;
    }

    #file-upload-label {
      background-color: #a39b4b;
      color: #000;
      width: 350px;
      height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      text-align: center;
      border: 2px dashed #000;
      position: relative;
    }

    #file-upload-label.dragover {
      background-color: #e0d96b;
    }

    #file-upload-label img {
      max-width: 80px;
      margin-top: 10px;
    }

    #file-upload-label input {
      display: none;
    }

    .form-area {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 20px;
      flex-grow: 1;
    }

    .form-area input,
    .form-area select {
      background-color: #a39b4b;
      border: none;
      padding: 10px;
      font-size: 18px;
      width: 100%;
      box-sizing: border-box;
      color: #000;
    }

    .form-full {
      grid-column: 1 / 3;
    }

    .form-area label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      color: #a39b4b;
    }

    #download-button {
      position: fixed;
      bottom: 20px;
      right: 30px;
      background: linear-gradient(to bottom, #ff3c00, #8b0000);
      color: black;
      font-family: 'Championship', Impact, sans-serif;
      font-size: 26px;
      font-weight: bold;
      padding: 15px 40px;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      z-index: 1000;
    }

    #image-preview {
      display: none;
      margin-top: 10px;
      max-width: 300px;
    }

    #error-message {
      color: red;
      display: none;
    }
  </style>
</head>
<body>

  <header>
    <img src="icone v2 nome.png" alt="Ícone Pixel 2 CM"/>
    <h1>REDIMENSIONE SUAS IMAGENS COM PRECISÃO PARA IMPRESSÃO PERFEITA!</h1>
  </header>

  <main>
    <label id="file-upload-label">
      SELECIONE<br>O ARQUIVO
      <img src="upload.png" alt="Upload">
      <input type="file" id="file-upload" accept="image/*" onchange="validateFile(event)">
    </label>

    <div class="form-area">
      <input type="number" id="height" placeholder="Altura">
      <input type="number" id="width" placeholder="Largura">
      <input type="number" id="dpi" value="300" placeholder="DPI">
      <select id="unit-select" onchange="convertUnits()">
        <option value="cm">cm</option>
        <option value="mm">mm</option>
        <option value="in">inches</option>
      </select>
      <select id="paper-size">
        <option value="A5">Folha A5</option>
        <option value="A4" selected>Folha A4</option>
        <option value="A3">Folha A3</option>
      </select>
      <input type="number" id="img-per-page" min="1" value="1" placeholder="Quantidade de imagens">
      <select id="file-type" class="form-full">
        <option value="png">PNG</option>
        <option value="jpeg">JPG</option>
        <option value="pdf">PDF</option>
      </select>

      <label class="form-full">
        Cor da linha de contorno:
        <select id="border-color">
          <option value="#000">Preto</option>
          <option value="#fff">Branco</option>
        </select>
      </label>

      <label class="form-full">
        <input type="checkbox" id="add-page-border"> Adicionar borda na página
      </label>

      <label class="form-full">
        <input type="checkbox" id="keep-aspect-ratio" checked> Manter proporção da imagem
      </label>
    </div>
  </main>

  <button id="download-button" onclick="downloadImage()" disabled>DOWNLOAD</button>

  <img id="image-preview">
  <span id="error-message">Tipo de arquivo inválido. Apenas PNG e JPG são aceitos.</span>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const fileInput = document.getElementById('file-upload');
    const dropArea = document.getElementById('file-upload-label');

    function cmTo(unit, value) {
      if (unit === 'cm') return value;
      if (unit === 'mm') return value * 10;
      if (unit === 'in') return value / 2.54;
    }

    function convertUnits() {
      const unit = document.getElementById('unit-select').value;
      const dpi = parseFloat(document.getElementById('dpi').value);
      const file = fileInput.files[0];
      if (!file) return;

      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = function () {
        const widthCm = img.width / dpi * 2.54;
        const heightCm = img.height / dpi * 2.54;
        document.getElementById('width').value = cmTo(unit, widthCm).toFixed(2);
        document.getElementById('height').value = cmTo(unit, heightCm).toFixed(2);
      };
    }

    function validateFile(event) {
      const file = event.target.files[0];
      const errorMessage = document.getElementById('error-message');
      if (file) {
        const allowed = ["image/png", "image/jpeg", "image/jpg"];
        if (!allowed.includes(file.type)) {
          errorMessage.style.display = 'block';
          fileInput.value = '';
        } else {
          errorMessage.style.display = 'none';
          const img = new Image();
          img.src = URL.createObjectURL(file);
          img.onload = function () {
            convertUnits();
            document.getElementById('image-preview').src = img.src;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('download-button').disabled = false;
          };
        }
      }
    }

    function getPaperDimensions(size, dpi) {
      const dims = {
        A5: [1748, 2480],
        A4: [2480, 3508],
        A3: [3508, 4960]
      };
      const scale = dpi / 300;
      return [Math.round(dims[size][0] * scale), Math.round(dims[size][1] * scale)];
    }

    function downloadImage() {
      const file = fileInput.files[0];
      const dpi = parseFloat(document.getElementById('dpi').value);
      const unit = document.getElementById('unit-select').value;
      let width = parseFloat(document.getElementById('width').value);
      let height = parseFloat(document.getElementById('height').value);
      const paper = document.getElementById('paper-size').value;
      const quantity = parseInt(document.getElementById('img-per-page').value);
      const fileType = document.getElementById('file-type').value;
      const borderColor = document.getElementById('border-color').value;
      const addPageBorder = document.getElementById('add-page-border').checked;
      const keepAspect = document.getElementById('keep-aspect-ratio').checked;

      if (!file) {
        alert("Selecione uma imagem primeiro");
        return;
      }

      // converter cm/mm/in para cm padrão
      if (unit === 'mm') {
        width /= 10;
        height /= 10;
      } else if (unit === 'in') {
        width *= 2.54;
        height *= 2.54;
      }

      // converter cm para px
      const widthPx = width / 2.54 * dpi;
      const heightPx = height / 2.54 * dpi;

      const [paperW, paperH] = getPaperDimensions(paper, dpi);

      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = function () {
        // Ajustar proporção da imagem se necessário
        let finalWidthPx = widthPx;
        let finalHeightPx = heightPx;
        if (keepAspect) {
          const aspectImg = img.width / img.height;
          const aspectTarget = widthPx / heightPx;
          if (aspectTarget > aspectImg) {
            finalWidthPx = heightPx * aspectImg;
            finalHeightPx = heightPx;
          } else {
            finalWidthPx = widthPx;
            finalHeightPx = widthPx / aspectImg;
          }
        }

        // Margem da página em pixels (2mm)
        const pagePadding = 2 / 25.4 * dpi;

        // Área útil (descontando margem)
        const usableWidth = paperW - 2 * pagePadding;
        const usableHeight = paperH - 2 * pagePadding;

        // Quantidade de colunas e linhas que cabem na área útil
        const cols = Math.floor(usableWidth / finalWidthPx);
        const rows = Math.floor(usableHeight / finalHeightPx);
        const maxImages = cols * rows;

        if (quantity > maxImages) {
          alert(`Quantidade máxima para este papel e tamanho é ${maxImages}`);
          return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = paperW;
        canvas.height = paperH;
        const ctx = canvas.getContext('2d');

        // Fundo da página (borda) ou branco
        ctx.fillStyle = addPageBorder ? borderColor : "#fff";
        ctx.fillRect(0, 0, paperW, paperH);

        if (addPageBorder) {
          // Área interna branca (margem)
          ctx.fillStyle = "#fff";
          ctx.fillRect(pagePadding, pagePadding, usableWidth, usableHeight);
        }

        // Desenhar as imagens na área útil, respeitando a margem
        let count = 0;
        for (let r = 0; r < rows && count < quantity; r++) {
          for (let c = 0; c < cols && count < quantity; c++) {
            const x = pagePadding + c * finalWidthPx;
            const y = pagePadding + r * finalHeightPx;

            // Fundo da imagem
            ctx.fillStyle = "#fff";
            ctx.fillRect(x, y, finalWidthPx, finalHeightPx);

            // Desenhar imagem
            ctx.drawImage(img, x, y, finalWidthPx, finalHeightPx);

            // Contorno da imagem
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, finalWidthPx, finalHeightPx);

            count++;
          }
        }

        if (fileType === "pdf") {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            unit: 'pt',
            format: [paperW * 72 / dpi, paperH * 72 / dpi] // converter px para pt para jsPDF
          });
          pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, paperW * 72 / dpi, paperH * 72 / dpi);
          pdf.save('imagem.pdf');
        } else {
          canvas.toBlob(function (blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'imagem.' + fileType;
            a.click();
            URL.revokeObjectURL(url);
          }, 'image/' + fileType);
        }
      };
    }
  </script>

</body>
</html>
